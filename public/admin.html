<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin â€” Affiliate Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0d1117;
      --surface:  #161b22;
      --surface2: #21262d;
      --border:   #30363d;
      --text:     #e6edf3;
      --muted:    #7d8590;
      --green:    #25D366;
      --yellow:   #f0a500;
      --red:      #f85149;
      --blue:     #58a6ff;
      --radius:   10px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      font-size: 14px;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .logo {
      font-size: 1rem;
      font-weight: 800;
      color: var(--green);
    }

    #hdr-info { font-size: 0.75rem; color: var(--muted); }

    /* TABS PRINCIPAIS */
    .main-tabs {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 28px;
      display: flex;
      gap: 4px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .main-tabs::-webkit-scrollbar { display: none; }

    .main-tab {
      padding: 14px 18px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
      transition: all .2s;
    }

    .main-tab:hover { color: var(--text); }
    .main-tab.active { color: var(--green); border-bottom-color: var(--green); }

    /* PAINEL */
    .painel { display: none; }
    .painel.active { display: block; }

    main { max-width: 1100px; margin: 0 auto; padding: 28px 20px 60px; }

    /* CARDS */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 28px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      border-top: 3px solid var(--green);
    }

    .card-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing:.1em; color: var(--muted); margin-bottom: 8px; }
    .card-value { font-size: 2rem; font-weight: 800; color: var(--green); line-height: 1; }
    .card-sub   { font-size: 0.75rem; color: var(--muted); margin-top: 5px; }

    /* FILTRO */
    .filtro {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 24px;
    }

    .fg { display: flex; flex-direction: column; gap: 5px; }
    .fg label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); font-weight: 600; }
    .fg input, .fg select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.82rem;
      padding: 7px 11px;
      outline: none;
    }
    .fg input:focus, .fg select:focus { border-color: var(--green); }

    /* BOTÃ•ES */
    .btn {
      padding: 8px 16px;
      border-radius: 7px;
      border: none;
      font-family: 'Inter', sans-serif;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity .15s;
    }
    .btn:hover { opacity: .85; }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .btn-green  { background: var(--green); color: #000; }
    .btn-ghost  { background: transparent; border: 1px solid var(--border); color: var(--muted); }
    .btn-yellow { background: var(--yellow); color: #000; }
    .btn-red    { background: var(--red); color: #fff; }
    .btn-blue   { background: var(--blue); color: #000; }
    .btn-sm { padding: 4px 10px; font-size: 0.75rem; }

    /* GRID 2 COLS */
    .grid2 { display: grid; grid-template-columns: 300px 1fr; gap: 20px; align-items: start; }
    @media (max-width: 860px) { .grid2 { grid-template-columns: 1fr; } }

    .section-title {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 12px;
    }

    /* RANKING */
    .ranking { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .rank-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .rank-item:last-child { border-bottom: none; }
    .rank-pos { width: 22px; font-size: 0.72rem; font-weight: 700; color: var(--muted); text-align: center; }
    .rank-pos.gold   { color: #f5c518; }
    .rank-pos.silver { color: #a8b0bd; }
    .rank-pos.bronze { color: #c97c3a; }
    .rank-name { flex: 1; font-size: 0.85rem; }
    .rank-bar-bg { width: 70px; height: 5px; background: var(--border); border-radius: 99px; overflow: hidden; }
    .rank-bar { height: 100%; background: var(--green); border-radius: 99px; }
    .rank-num { width: 30px; text-align: right; font-weight: 700; font-size: 0.82rem; color: var(--green); }

    /* TABELA */
    .tabela-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead { background: var(--surface2); }
    thead th { padding: 10px 14px; text-align: left; font-size: 0.68rem; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); font-weight: 600; border-bottom: 1px solid var(--border); }
    tbody tr { border-bottom: 1px solid var(--border); }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--surface2); }
    tbody td { padding: 10px 14px; }

    .badge {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 99px;
      font-size: 0.72rem;
      font-weight: 600;
      background: rgba(37,211,102,.12);
      color: var(--green);
      border: 1px solid rgba(37,211,102,.25);
    }

    .mono { font-family: 'JetBrains Mono', monospace; color: var(--muted); font-size: 0.78rem; }

    /* PAGINAÃ‡ÃƒO */
    .pag { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; border-top: 1px solid var(--border); }
    .pag-info { font-size: 0.75rem; color: var(--muted); }

    /* STATUS */
    .status-pago { background: rgba(37,211,102,.12); color: var(--green); border: 1px solid rgba(37,211,102,.25); border-radius: 99px; padding: 2px 9px; font-size: .72rem; font-weight: 600; }
    .status-pendente { background: rgba(240,165,0,.1); color: var(--yellow); border: 1px solid rgba(240,165,0,.25); border-radius: 99px; padding: 2px 9px; font-size: .72rem; font-weight: 600; }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 999; padding: 20px;
      display: none;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 32px;
      width: 100%;
      max-width: 440px;
    }

    .modal h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; }

    .modal .field { margin-bottom: 16px; }
    .modal .field label { display: block; font-size: 0.72rem; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); font-weight: 600; margin-bottom: 6px; }
    .modal .field input,
    .modal .field select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      padding: 10px 13px;
      outline: none;
    }
    .modal .field input:focus,
    .modal .field select:focus { border-color: var(--green); }

    .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
    .modal-btns .btn { flex: 1; padding: 11px; }

    .msg-modal { font-size: 0.82rem; color: var(--red); margin-top: 10px; display: none; }
    .msg-modal.show { display: block; }

    /* ESTADOS */
    .empty { text-align: center; padding: 40px 20px; color: var(--muted); }
    .empty .icon { font-size: 2rem; margin-bottom: 8px; }
    .spin { display: inline-block; width: 26px; height: 26px; border: 3px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin .7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .erro-box { background: rgba(248,81,73,.1); border: 1px solid rgba(248,81,73,.3); border-radius: 8px; padding: 12px 16px; color: var(--red); font-size: 0.85rem; margin-bottom: 20px; display: none; }

    @media (max-width: 600px) {
      header { padding: 14px 16px; }
      .main-tabs { padding: 0 16px; }
      main { padding: 20px 14px 40px; }
      .filtro { flex-direction: column; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">ğŸ“¡ Painel Admin</div>
  <div id="hdr-info">â€”</div>
</header>

<!-- TABS PRINCIPAIS -->
<div class="main-tabs">
  <div class="main-tab active" onclick="abrirAba('cliques')">ğŸ“Š Cliques</div>
  <div class="main-tab" onclick="abrirAba('usuarios')">ğŸ‘¥ UsuÃ¡rios</div>
  <div class="main-tab" onclick="abrirAba('pagamentos')">ğŸ’° Pagamentos</div>
</div>

<main>
  <div class="erro-box" id="erro-global"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• ABA CLIQUES â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="painel active" id="painel-cliques">
    <div class="cards">
      <div class="card">
        <div class="card-label">Total de cliques</div>
        <div class="card-value" id="c-total">â€”</div>
        <div class="card-sub">No perÃ­odo</div>
      </div>
      <div class="card">
        <div class="card-label">Afiliados ativos</div>
        <div class="card-value" id="c-afiliados">â€”</div>
        <div class="card-sub">Com ao menos 1 clique</div>
      </div>
      <div class="card">
        <div class="card-label">Top afiliado</div>
        <div class="card-value" id="c-top" style="font-size:1.2rem">â€”</div>
        <div class="card-sub" id="c-top-n">â€”</div>
      </div>
    </div>

    <div class="filtro">
      <div class="fg"><label>De</label><input type="date" id="de" /></div>
      <div class="fg"><label>AtÃ©</label><input type="date" id="ate" /></div>
      <button class="btn btn-green" onclick="carregarCliques()">Filtrar</button>
      <button class="btn btn-ghost" onclick="limparFiltro()">Limpar</button>
      <button class="btn btn-ghost" onclick="carregarCliques()" style="margin-left:auto">â†»</button>
    </div>

    <div class="grid2">
      <div>
        <div class="section-title">ğŸ† Ranking</div>
        <div class="ranking" id="ranking"><div class="empty"><div class="spin"></div></div></div>
      </div>
      <div>
        <div class="section-title">ğŸ“‹ HistÃ³rico</div>
        <div class="tabela-wrap">
          <table>
            <thead>
              <tr><th>Afiliado</th><th>IP</th><th>Data</th></tr>
            </thead>
            <tbody id="tbody-cliques">
              <tr><td colspan="3"><div class="empty"><div class="spin"></div></div></td></tr>
            </tbody>
          </table>
          <div class="pag" id="pag-cliques" style="display:none">
            <button class="btn btn-ghost btn-sm" id="ant-c" onclick="pagCliques(-1)">â† Ant.</button>
            <span class="pag-info" id="info-c"></span>
            <button class="btn btn-ghost btn-sm" id="prox-c" onclick="pagCliques(1)">PrÃ³x. â†’</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• ABA USUÃRIOS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="painel" id="painel-usuarios">
    <div class="cards">
      <div class="card">
        <div class="card-label">Total de usuÃ¡rios</div>
        <div class="card-value" id="u-total">â€”</div>
        <div class="card-sub">Cadastrados na plataforma</div>
      </div>
    </div>

    <div class="section-title">ğŸ‘¥ UsuÃ¡rios cadastrados</div>
    <div class="tabela-wrap">
      <table>
        <thead>
          <tr><th>E-mail</th><th>Afiliado</th><th>Chave Pix</th><th>Cadastro</th><th>AÃ§Ã£o</th></tr>
        </thead>
        <tbody id="tbody-usuarios">
          <tr><td colspan="5"><div class="empty"><div class="spin"></div></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• ABA PAGAMENTOS â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="painel" id="painel-pagamentos">
    <div class="cards">
      <div class="card">
        <div class="card-label">Total pago</div>
        <div class="card-value" id="p-total-pago">â€”</div>
        <div class="card-sub">Pagamentos concluÃ­dos</div>
      </div>
      <div class="card">
        <div class="card-label">A pagar</div>
        <div class="card-value" id="p-total-pend" style="color:var(--yellow)">â€”</div>
        <div class="card-sub">Pagamentos pendentes</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; gap:10px;">
      <div class="section-title" style="margin:0">ğŸ’° Todos os pagamentos</div>
      <button class="btn btn-green" onclick="abrirModalPagamento()">+ Registrar pagamento</button>
    </div>

    <div class="tabela-wrap">
      <table>
        <thead>
          <tr><th>Afiliado</th><th>E-mail</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>Status</th><th>Data</th><th>AÃ§Ã£o</th></tr>
        </thead>
        <tbody id="tbody-pagamentos">
          <tr><td colspan="7"><div class="empty"><div class="spin"></div></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- MODAL: REGISTRAR PAGAMENTO -->
<div class="modal-overlay" id="modal-pagamento">
  <div class="modal">
    <h3>ğŸ’° Registrar pagamento</h3>
    <div class="field">
      <label>UsuÃ¡rio (afiliado)</label>
      <select id="modal-user"></select>
    </div>
    <div class="field">
      <label>Valor (R$)</label>
      <input type="number" id="modal-valor" placeholder="0.00" min="0.01" step="0.01" />
    </div>
    <div class="field">
      <label>DescriÃ§Ã£o</label>
      <input type="text" id="modal-desc" placeholder="ex: ComissÃ£o semana 1" />
    </div>
    <div class="field">
      <label>Status</label>
      <select id="modal-status">
        <option value="pendente">â³ Pendente</option>
        <option value="pago">âœ“ Pago</option>
      </select>
    </div>
    <div class="msg-modal" id="msg-modal"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="fecharModal()">Cancelar</button>
      <button class="btn btn-green" id="btn-salvar-pag" onclick="salvarPagamento()">Salvar</button>
    </div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const SENHA  = params.get("senha") || "";

  // â”€â”€ UTILITÃRIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmtData(iso) {
    if (!iso) return "â€”";
    return new Date(iso).toLocaleDateString("pt-BR", {day:"2-digit", month:"2-digit", year:"numeric"});
  }

  function fmtMoeda(v) {
    return Number(v).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  function mostrarErro(msg) {
    const el = document.getElementById("erro-global");
    el.textContent = "âŒ " + msg;
    el.style.display = "block";
    setTimeout(() => el.style.display = "none", 6000);
  }

  function posClass(i) {
    if (i === 0) return "gold";
    if (i === 1) return "silver";
    if (i === 2) return "bronze";
    return "";
  }

  // â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function abrirAba(aba) {
    document.querySelectorAll(".main-tab").forEach((t, i) => {
      const abas = ["cliques","usuarios","pagamentos"];
      t.classList.toggle("active", abas[i] === aba);
    });
    document.querySelectorAll(".painel").forEach(p => p.classList.remove("active"));
    document.getElementById("painel-" + aba).classList.add("active");

    if (aba === "usuarios")   carregarUsuarios();
    if (aba === "pagamentos") carregarPagamentos();
  }

  // â”€â”€ ABA CLIQUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let todosCliques = [];
  let pagC = 1;
  const POR_PAG = 25;

  function limparFiltro() {
    document.getElementById("de").value = "";
    document.getElementById("ate").value = "";
    carregarCliques();
  }

  function renderCliques() {
    const corpo = document.getElementById("tbody-cliques");
    const inicio = (pagC - 1) * POR_PAG;
    const fatia = todosCliques.slice(inicio, inicio + POR_PAG);
    const totPag = Math.ceil(todosCliques.length / POR_PAG) || 1;

    if (fatia.length === 0) {
      corpo.innerHTML = `<tr><td colspan="3"><div class="empty"><div class="icon">ğŸ”</div><p>Nenhum clique</p></div></td></tr>`;
      document.getElementById("pag-cliques").style.display = "none";
      return;
    }

    corpo.innerHTML = fatia.map(c => `
      <tr>
        <td><span class="badge">${c.affiliate||"â€”"}</span></td>
        <td><span class="mono">${c.ip||"â€”"}</span></td>
        <td>${fmtData(c.created_at)}</td>
      </tr>
    `).join("");

    document.getElementById("info-c").textContent = `PÃ¡g. ${pagC}/${totPag}`;
    document.getElementById("ant-c").disabled  = pagC <= 1;
    document.getElementById("prox-c").disabled = pagC >= totPag;
    document.getElementById("pag-cliques").style.display = todosCliques.length > POR_PAG ? "flex" : "none";
  }

  function pagCliques(d) {
    pagC = Math.max(1, Math.min(Math.ceil(todosCliques.length / POR_PAG), pagC + d));
    renderCliques();
  }

  async function carregarCliques() {
    const de  = document.getElementById("de").value;
    const ate = document.getElementById("ate").value;

    document.getElementById("ranking").innerHTML = `<div class="empty"><div class="spin"></div></div>`;
    document.getElementById("tbody-cliques").innerHTML = `<tr><td colspan="3"><div class="empty"><div class="spin"></div></div></td></tr>`;

    const qs = new URLSearchParams({ senha: SENHA });
    if (de)  qs.append("de",  de);
    if (ate) qs.append("ate", ate);

    try {
      const r = await fetch(`/api/stats?${qs}`);
      if (r.status === 401) { window.location.href = "/admin"; return; }
      if (!r.ok) throw new Error("HTTP " + r.status);

      const d = await r.json();

      document.getElementById("c-total").textContent     = d.total ?? 0;
      document.getElementById("c-afiliados").textContent = d.ranking?.length ?? 0;
      document.getElementById("c-top").textContent       = d.ranking?.[0]?.affiliate ?? "â€”";
      document.getElementById("c-top-n").textContent     = d.ranking?.[0] ? `${d.ranking[0].total} clique(s)` : "Sem dados";
      document.getElementById("hdr-info").textContent    = "Atualizado: " + new Date().toLocaleTimeString("pt-BR");

      const max = d.ranking?.[0]?.total || 1;
      document.getElementById("ranking").innerHTML = (d.ranking || []).length === 0
        ? `<div class="empty"><div class="icon">ğŸ“­</div><p>Sem dados</p></div>`
        : (d.ranking || []).map((r, i) => `
          <div class="rank-item">
            <span class="rank-pos ${posClass(i)}">#${i+1}</span>
            <span class="rank-name">${r.affiliate}</span>
            <div class="rank-bar-bg"><div class="rank-bar" style="width:${Math.round(r.total/max*100)}%"></div></div>
            <span class="rank-num">${r.total}</span>
          </div>
        `).join("");

      todosCliques = d.cliques || [];
      pagC = 1;
      renderCliques();

    } catch (e) {
      mostrarErro("Erro ao carregar cliques: " + e.message);
    }
  }

  // â”€â”€ ABA USUÃRIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let listaUsuarios = [];

  async function carregarUsuarios() {
    document.getElementById("tbody-usuarios").innerHTML =
      `<tr><td colspan="5"><div class="empty"><div class="spin"></div></div></td></tr>`;

    try {
      const r = await fetch(`/api/admin/users?senha=${encodeURIComponent(SENHA)}`);
      if (!r.ok) throw new Error("HTTP " + r.status);
      const d = await r.json();

      listaUsuarios = d.users || [];
      document.getElementById("u-total").textContent = listaUsuarios.length;

      if (listaUsuarios.length === 0) {
        document.getElementById("tbody-usuarios").innerHTML =
          `<tr><td colspan="5"><div class="empty"><div class="icon">ğŸ‘¥</div><p>Nenhum usuÃ¡rio cadastrado</p></div></td></tr>`;
        return;
      }

      document.getElementById("tbody-usuarios").innerHTML = listaUsuarios.map(u => `
        <tr>
          <td>${u.email}</td>
          <td><span class="badge">${u.affiliate}</span></td>
          <td><span class="mono">${u.pix_key}</span></td>
          <td>${fmtData(u.created_at)}</td>
          <td>
            <button class="btn btn-yellow btn-sm"
              onclick="abrirModalPagamento(${u.id}, '${u.affiliate}')">
              + Pagamento
            </button>
          </td>
        </tr>
      `).join("");

    } catch (e) {
      mostrarErro("Erro ao carregar usuÃ¡rios: " + e.message);
    }
  }

  // â”€â”€ ABA PAGAMENTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function carregarPagamentos() {
    document.getElementById("tbody-pagamentos").innerHTML =
      `<tr><td colspan="7"><div class="empty"><div class="spin"></div></div></td></tr>`;

    try {
      const r = await fetch(`/api/admin/payments?senha=${encodeURIComponent(SENHA)}`);
      if (!r.ok) throw new Error("HTTP " + r.status);
      const d = await r.json();
      const payments = d.payments || [];

      const totalPago = payments.filter(p => p.status === "pago").reduce((s, p) => s + Number(p.amount), 0);
      const totalPend = payments.filter(p => p.status === "pendente").reduce((s, p) => s + Number(p.amount), 0);

      document.getElementById("p-total-pago").textContent = fmtMoeda(totalPago);
      document.getElementById("p-total-pend").textContent = fmtMoeda(totalPend);

      if (payments.length === 0) {
        document.getElementById("tbody-pagamentos").innerHTML =
          `<tr><td colspan="7"><div class="empty"><div class="icon">ğŸ’³</div><p>Nenhum pagamento registrado</p></div></td></tr>`;
        return;
      }

      document.getElementById("tbody-pagamentos").innerHTML = payments.map(p => `
        <tr>
          <td><span class="badge">${p.users?.affiliate || "â€”"}</span></td>
          <td>${p.users?.email || "â€”"}</td>
          <td>${p.description || "â€”"}</td>
          <td style="font-weight:700;font-family:monospace">${fmtMoeda(p.amount)}</td>
          <td>
            <span class="status-${p.status}">
              ${p.status === "pago" ? "âœ“ Pago" : "â³ Pendente"}
            </span>
          </td>
          <td>${fmtData(p.created_at)}</td>
          <td>
            ${p.status === "pendente"
              ? `<button class="btn btn-green btn-sm" onclick="marcarPago(${p.id}, this)">Marcar pago</button>`
              : `<span style="color:var(--muted);font-size:.75rem">â€”</span>`
            }
          </td>
        </tr>
      `).join("");

    } catch (e) {
      mostrarErro("Erro ao carregar pagamentos: " + e.message);
    }
  }

  async function marcarPago(id, btn) {
    btn.disabled = true;
    btn.textContent = "...";
    try {
      const r = await fetch(`/api/admin/payments/${id}?senha=${encodeURIComponent(SENHA)}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "pago" }),
      });
      if (!r.ok) throw new Error("HTTP " + r.status);
      carregarPagamentos();
    } catch (e) {
      mostrarErro("Erro ao atualizar: " + e.message);
      btn.disabled = false;
      btn.textContent = "Marcar pago";
    }
  }

  // â”€â”€ MODAL PAGAMENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function abrirModalPagamento(userId, affiliate) {
    // Popula o select de usuÃ¡rios
    const sel = document.getElementById("modal-user");
    sel.innerHTML = listaUsuarios.map(u =>
      `<option value="${u.id}" ${u.id === userId ? "selected" : ""}>${u.affiliate} â€” ${u.email}</option>`
    ).join("");

    // Se nÃ£o hÃ¡ usuÃ¡rios carregados, carrega primeiro
    if (listaUsuarios.length === 0) {
      carregarUsuarios().then(() => {
        sel.innerHTML = listaUsuarios.map(u =>
          `<option value="${u.id}">${u.affiliate} â€” ${u.email}</option>`
        ).join("");
      });
    }

    document.getElementById("modal-valor").value = "";
    document.getElementById("modal-desc").value  = "";
    document.getElementById("modal-status").value = "pendente";
    document.getElementById("msg-modal").className = "msg-modal";

    document.getElementById("modal-pagamento").classList.add("open");
  }

  function fecharModal() {
    document.getElementById("modal-pagamento").classList.remove("open");
  }

  async function salvarPagamento() {
    const user_id     = document.getElementById("modal-user").value;
    const amount      = document.getElementById("modal-valor").value;
    const description = document.getElementById("modal-desc").value.trim();
    const status      = document.getElementById("modal-status").value;
    const btn         = document.getElementById("btn-salvar-pag");
    const msg         = document.getElementById("msg-modal");

    if (!user_id || !amount || Number(amount) <= 0) {
      msg.textContent = "Selecione um usuÃ¡rio e informe um valor vÃ¡lido.";
      msg.className = "msg-modal show";
      return;
    }

    btn.disabled = true;
    btn.textContent = "Salvando...";
    msg.className = "msg-modal";

    try {
      const r = await fetch(`/api/admin/payments?senha=${encodeURIComponent(SENHA)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, amount: Number(amount), description, status }),
      });
      const d = await r.json();
      if (!r.ok) throw new Error(d.erro || "Erro ao salvar.");

      fecharModal();
      carregarPagamentos();

    } catch (e) {
      msg.textContent = e.message;
      msg.className = "msg-modal show";
    } finally {
      btn.disabled = false;
      btn.textContent = "Salvar";
    }
  }

  // Fecha modal clicando fora
  document.getElementById("modal-pagamento").addEventListener("click", function(e) {
    if (e.target === this) fecharModal();
  });

  // â”€â”€ INICIALIZAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const hoje = new Date();
  const h30  = new Date();
  h30.setDate(hoje.getDate() - 30);
  document.getElementById("de").value  = h30.toISOString().slice(0,10);
  document.getElementById("ate").value = hoje.toISOString().slice(0,10);

  carregarCliques();
  setInterval(carregarCliques, 60000);
</script>
</body>
</html>
