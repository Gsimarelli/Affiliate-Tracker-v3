<script>
  const TOKEN = localStorage.getItem("token");

  if (!TOKEN) {
    window.location.href = "/login";
  }

  const HEADERS = {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + TOKEN,
  };

  function fmtData(iso) {
    if (!iso) return "‚Äî";
    return new Date(iso).toLocaleDateString("pt-BR");
  }

  function fmtMoeda(v) {
    return Number(v || 0).toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL"
    });
  }

  function sair() {
    localStorage.removeItem("token");
    window.location.href = "/login";
  }

  async function copiarLink() {
    const link = document.getElementById("link-afiliado").textContent;
    const btn = document.querySelector(".btn-copy");

    try {
      await navigator.clipboard.writeText(link);
      btn.textContent = "‚úì Copiado!";
      setTimeout(() => btn.textContent = "Copiar", 2000);
    } catch {
      alert("N√£o foi poss√≠vel copiar o link.");
    }
  }

  async function fetchSeguro(url) {
    const r = await fetch(url, { headers: HEADERS });

    if (r.status === 401) {
      sair();
      return null;
    }

    if (!r.ok) {
      console.error("Erro API:", url, r.status);
      return null;
    }

    return await r.json();
  }

  async function carregarDados() {
    try {
      const me = await fetchSeguro("/api/me");
      if (!me) return;

      document.getElementById("hdr-email").textContent = me.email || "‚Äî";

      document.getElementById("link-afiliado").textContent =
        me.link || window.location.origin + "/a/" + (me.affiliate || "");

      document.getElementById("info-grid").innerHTML = `
        <div class="info-row">
          <span class="info-label">E-mail</span>
          <span class="info-value">${me.email || "‚Äî"}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Chave Pix</span>
          <span class="info-value">${me.pix_key || "‚Äî"}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Afiliado</span>
          <span class="info-value">${me.affiliate || "‚Äî"}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Membro desde</span>
          <span class="info-value">${fmtData(me.created_at)}</span>
        </div>
      `;

      const cliques = await fetchSeguro("/api/me/clicks");
      document.getElementById("c-cliques").textContent =
        cliques?.total ?? 0;

      const pag = await fetchSeguro("/api/me/payments");
      const payments = pag?.payments || [];

      const tbody = document.getElementById("tbody-pagamentos");

      if (payments.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4">
              <div class="empty">
                <div class="icon">üí≥</div>
                <p>Nenhum pagamento registrado ainda</p>
              </div>
            </td>
          </tr>
        `;

        document.getElementById("c-recebido").textContent = fmtMoeda(0);
        document.getElementById("c-pendente").textContent = fmtMoeda(0);
        return;
      }

      tbody.innerHTML = payments.map(p => {
        const status = (p.status || "").toLowerCase();

        return `
          <tr>
            <td>${p.description || "‚Äî"}</td>
            <td class="valor">${fmtMoeda(p.amount)}</td>
            <td>
              <span class="status-badge ${status}">
                ${status === "pago" ? "‚úì Pago" : "‚è≥ Pendente"}
              </span>
            </td>
            <td>${fmtData(p.created_at)}</td>
          </tr>
        `;
      }).join("");

      const totalPago = payments
        .filter(p => (p.status || "").toLowerCase() === "pago")
        .reduce((s, p) => s + Number(p.amount || 0), 0);

      const totalPendente = payments
        .filter(p => (p.status || "").toLowerCase() === "pendente")
        .reduce((s, p) => s + Number(p.amount || 0), 0);

      document.getElementById("c-recebido").textContent = fmtMoeda(totalPago);
      document.getElementById("c-pendente").textContent = fmtMoeda(totalPendente);
      document.getElementById("total-pago").textContent = fmtMoeda(totalPago);
      document.getElementById("tfoot-total").style.display = "";

    } catch (e) {
      console.error("Erro geral:", e);
    }
  }

  carregarDados();
</script>
